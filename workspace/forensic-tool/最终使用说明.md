# Windows DLL 编译 - 最终版本说明

## 文件状态

已更新以下三个文件：

1. **include/dirent.h**
   - 使用 `FS_DIRENT_TYPE` 和 `FS_DIR_TYPE` 前缀
   - Windows 下定义结构，Linux 下使用系统类型
   - 完全避免与系统头文件冲突

2. **src/file_scanner.c**
   - Windows 下使用 `fs_opendir`, `fs_readdir`, `fs_closedir` 前缀
   - Linux 下使用系统函数
   - 三个导出函数：`scan_files`, `extract_content`, `free_files`

3. **build.bat**
   - 纯英文提示
   - 检查 VS x64 环境
   - 编译和链接 DLL

## 关键改进

### 1. 函数前缀

Windows 下的目录操作函数使用 `fs_` 前缀：
- `fs_opendir` - 打开目录
- `fs_readdir` - 读取目录项
- `fs_closedir` - 关闭目录

### 2. 类型前缀

结构类型使用 `FS_` 前缀：
- `FS_DIRENT_TYPE` - 目录项类型
- `FS_DIR_TYPE` - 目录类型

### 3. 条件编译

```c
#ifdef _WIN32
// Windows 实现（使用 fs_ 前缀）
EXPORT FS_DIR_TYPE *fs_opendir(const char *dirname) { ... }
#else
// Linux 实现（使用系统函数）
// opendir, readdir, closedir 在 dirent.h 中
#endif
```

## 使用方法

### 在 Windows 环境中

#### 步骤 1: 确保文件编码

打开每个文件，检查编码：
- 右键 → 属性
- 确保是 **ANSI** 或 **UTF-8 without BOM**

如果不是，重新保存：
- 右键 → 另存为
- 编码选择：**ANSI**
- 保存

#### 步骤 2: 编译

1. 打开 "x64 Native Tools Command Prompt for VS"
2. 切换到项目目录：
   ```cmd
   cd /d D:\sqlite-tool\v3\workspace\forensic-tool
   ```
3. 运行编译：
   ```cmd
   build.bat
   ```

### 预期结果

成功后输出：

```
Building Forensic Tool C Module - Windows x64

VS x64 environment detected, starting compilation...

[1/2] Compiling C source file...
[2/2] Linking to generate DLL...

================================================
Build SUCCESS!
================================================

Generated files:
  - build\scanner.dll
  - build\scanner.lib
  - src\file_scanner.obj
```

## 核心解决方案

通过使用 `fs_` 前缀：
1. **避免函数重定义** - `fs_opendir` vs `opendir`
2. **避免类型冲突** - `FS_DIR_TYPE` vs `DIR`
3. **保持语义清晰** - 前缀明确表示是文件扫描器
4. **跨平台兼容** - Linux 下正常使用系统函数

## 技术细节

### dirent.h 结构

```c
#ifdef _WIN32
#define FS_DIRENT_TYPE struct { ... }
#define FS_DIR_TYPE struct { ... }
#else
#define FS_DIRENT_TYPE struct dirent
#define FS_DIR_TYPE DIR
#endif
```

### file_scanner.c 导出函数

```c
EXPORT void scan_files(const char *root_dir, char ***file_paths, int *file_count);
EXPORT char *extract_content(const char *file_path, int *content_len);
EXPORT void free_files(char **file_paths, int file_count);
```

### Windows 专用函数

```c
EXPORT FS_DIR_TYPE *fs_opendir(const char *dirname);
EXPORT FS_DIRENT_TYPE *fs_readdir(FS_DIR_TYPE *dirp);
EXPORT int fs_closedir(FS_DIR_TYPE *dirp);
```

这些函数只在 Windows 下定义，不会与 Linux 系统函数冲突。

## 验证编译

在 Windows 环境中编译后，检查生成的 DLL：

```cmd
dir build\scanner.dll
dumpbin /exports build\scanner.dll
```

应该看到三个导出函数：
- `scan_files`
- `extract_content`
- `free_files`

## 测试运行

编译成功后：

1. 安装 Python 依赖：
   ```cmd
   pip install -r requirements.txt
   pip install fakeredis
   ```

2. 运行 Python 程序：
   ```cmd
   python main.py
   ```

3. 测试 API：
   ```cmd
   curl http://localhost:8000/
   ```

## 文件清单

确保你的 Windows 项目目录包含：

```
forensic-tool/
├── include/
│   └── dirent.h          # 已更新
├── src/
│   └── file_scanner.c   # 已更新
├── build.bat               # 已更新
├── main.py
├── ui.py
└── requirements.txt
```

## 下一步

1. 确保文件编码正确（ANSI）
2. 在 VS x64 命令提示符中编译
3. 验证编译成功
4. 运行测试程序
5. 提交代码到 Git

---

**注意**: Linux 环境下的 LSP 警告可以忽略，因为这些文件是专为 Windows 设计的。
